<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asia Car Trust</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4">
    <div class="max-w-md mx-auto">
        <h1 class="text-2xl font-bold mb-6 text-center">Каталог авто</h1>
        <div class="grid grid-cols-2 gap-2 mb-4">
            <select id="mark" class="p-3 rounded-xl border bg-white" onchange="updateModels()">
                <option value="">Марка</option>
                <option value="TOYOTA">Toyota</option>
                <option value="GEELY">Geely</option>
                <option value="ZEEKR">Zeekr</option>
            </select>
            <select id="model" class="p-3 rounded-xl border bg-white">
                <option value="">Модель</option>
            </select>
        </div>
        <button onclick="loadCars()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">ПОИСК</button>
        <div id="list" class="mt-6 space-y-4 pb-10">
            <p class="text-center text-gray-400 text-sm">Выберите параметры</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const modelData = {
            "TOYOTA": ["Camry", "RAV4"],
            "GEELY": ["Monjaro", "Tugella"],
            "ZEEKR": ["001", "X"]
        };

        function updateModels() {
            const mark = document.getElementById('mark').value;
            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = '<option value="">Модель</option>';
            if (modelData[mark]) {
                modelData[mark].forEach(m => {
                    modelSelect.innerHTML += `<option value="${m.toUpperCase()}">${m}</option>`;
                });
            }
        }

        async function loadCars() {
            const mark = document.getElementById('mark').value;
            const model = document.getElementById('model').value;
            const list = document.getElementById('list');
            list.innerHTML = '<p class="text-center py-10 animate-pulse">Загрузка...</p>';

            try {
                // Добавляем случайное число к ссылке (?t=...), чтобы заставить n8n отдать свежие данные (сброс кэша)
                const apiUrl = `https://plifartorikern.beget.app/webhook/get-cars?mark=${mark}&model=${model}&t=${new Date().getTime()}`;
                
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error(`Ошибка: ${res.status}`);
                
                const data = await res.json();
                list.innerHTML = '';

                if (!data || data.length === 0) {
                    list.innerHTML = '<p class="text-center p-10">❌ Ничего не найдено</p>';
                    return;
                }

                data.forEach(car => {
                    list.innerHTML += `
                        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                            <img src="${car.photo}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="font-bold">${car.name}</h3>
                                <p class="text-xs text-gray-500">${car.year} г. | ${car.km} км</p>
                                <div class="mt-3 flex justify-between items-center">
                                    <span class="text-blue-600 font-bold text-lg">${car.priceRub} ₽</span>
                                    <a href="${car.url}" target="_blank" class="bg-blue-50 text-blue-700 px-3 py-1 rounded text-xs font-bold uppercase">Сайт</a>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (e) {
                list.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-xl text-center">Ошибка соединения<br><small>${e.message}</small></div>`;
            }
        }
    </script>
</body>
</html>
