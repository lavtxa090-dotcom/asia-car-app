<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asia Car Trust</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-3">
    <div class="max-w-md mx-auto">
        <h1 class="text-2xl font-bold mb-4 text-center">Каталог авто из Китая</h1>
        
        <div class="grid grid-cols-2 gap-2 mb-4">
            <select id="mark" class="p-3 rounded-xl border bg-white focus:outline-none" onchange="updateModels()">
                <option value="">Марка</option>
                <option value="TOYOTA">Toyota</option>
                <option value="GEELY">Geely</option>
                <option value="ZEEKR">Zeekr</option>
                <option value="LI AUTO">Li Auto</option>
            </select>
            <select id="model" class="p-3 rounded-xl border bg-white focus:outline-none">
                <option value="">Все модели</option>
            </select>
        </div>
        <button onclick="loadCars()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">НАЙТИ МАШИНЫ</button>

        <div id="list" class="mt-6 grid grid-cols-1 gap-4 pb-10">
            <p class="text-center text-gray-500">Выберите марку и нажмите поиск</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const modelData = {
            "TOYOTA": ["Camry", "RAV4", "Levin", "Highlander"],
            "GEELY": ["Monjaro", "Tugella", "Coolray", "Preface"],
            "ZEEKR": ["001", "007", "009", "X"],
            "LI AUTO": ["L6", "L7", "L8", "L9"]
        };

        function updateModels() {
            const mark = document.getElementById('mark').value;
            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = '<option value="">Все модели</option>';
            if (modelData[mark]) {
                modelData[mark].forEach(m => {
                    modelSelect.innerHTML += `<option value="${m.toUpperCase()}">${m}</option>`;
                });
            }
        }

        async function loadCars() {
            const mark = document.getElementById('mark').value;
            const model = document.getElementById('model').value;
            const list = document.getElementById('list');
            list.innerHTML = '<div class="text-center py-10"><p class="animate-pulse">Связь с Китаем...</p></div>';

            try {
                // Используем упрощенный URL для обхода проблем CORS
                const apiUrl = `https://plifartorikern.beget.app/webhook/get-cars?mark=${mark}&model=${model}`;
                const res = await fetch(apiUrl);
                
                if (!res.ok) throw new Error(`Ошибка сервера: ${res.status}`);
                const data = await res.json();

                list.innerHTML = '';
                if (!data || data.length === 0) {
                    list.innerHTML = '<div class="text-center p-10 bg-white rounded-2xl italic text-gray-400">Ничего не найдено</div>';
                    return;
                }

                data.forEach(car => {
                    list.innerHTML += `
                        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100 mb-4">
                            <img src="${car.photo}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="font-bold text-lg text-gray-900">${car.name}</h3>
                                <p class="text-sm text-gray-500">${car.year} г. | ${car.km} км</p>
                                <div class="mt-3 flex justify-between items-center">
                                    <span class="text-blue-600 font-extrabold text-xl">${car.priceRub} ₽</span>
                                    <a href="${car.url}" target="_blank" class="bg-blue-50 text-blue-700 text-xs px-4 py-2 rounded-lg font-bold">ОРИГИНАЛ</a>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (e) { 
                list.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-xl text-center font-bold">❌ Ошибка загрузки<br><span class="text-xs font-normal">${e.message}</span></div>`;
            }
        }
    </script>
</body>
</html>
